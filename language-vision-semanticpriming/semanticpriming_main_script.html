

<!DOCTYPE html>
<html>

  <head>

    <!-- Load in jsPsych library and plugins -->
    <script src = 'https://unpkg.com/jspsych@7.3.0'></script>
    <script src = 'https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.1'></script>
    <script src = 'https://unpkg.com/@jspsych/plugin-html-button-response@1.1.1'></script>

    <!-- Load in in stimuli -->
    <script src = 'js/semanticpriming_stimuli_initial_practice.js'></script>
    <script src = 'js/semanticpriming_stimuli_extra_practice.js'></script>
    <script src = 'js/semanticpriming_stimuli_main_procedure.js'></script>

    <!-- Load in CSS -->
    <link href = 'https://unpkg.com/jspsych@7.3.0/css/jspsych.css' rel='stylesheet' type='text/css' />

    <!-- Apply further CSS -->
    <style>
      /* Throughout experiment, dark-grey background and light-grey text */
      body.jspsych-display-element {
        color: #ececec;
        background-color: #2b2b2b;
      }

      /* Large font size */
      #jspsych-html-keyboard-response-stimulus {
        font-size: 32px;
      }

    </style>

  </head>



  <!-- Beginning of the script that contains the core of the experiment -->
  <script>

    /* Initialize experiment specifying what should be 
    returned as the output of the experiment */
    var jsPsych = initJsPsych({
      on_finish: function() {
        jsPsych.data.displayData();
        jsPsych.data.get().csv();
      },
      /* Set 200 ms as the minimum time between stimulus onset and response. This minimum 
      time has been applied in the removal of invalid trials in studies on word processing 
      (Balota et al., 2007, https://doi.org/10.3758/BF03193014; Hutchison et al., 2013, 
      https://doi.org/10.3758/s13428-012-0304-z), as well as in visual perception studies 
      (Strittmatter et al., 2022, https://doi.org/10.3758/s13428-021-01767-3). In the 
      present study, the minimum time is implemented as a constraint in the experiment to 
      prevent the collection of invalid trials.*/
      minimum_valid_rt: 200
    });
  
    /* Create empty timeline object, which will be sequentially filled 
    in using timeline.push(). */
    var timeline = [];

    var instructions = {
      type: jsPsychHtmlButtonResponse,
      stimulus: ["<b>Abstract</b> words describe concepts that we cannot normally experience directly, </p> " +
        '<p> whereas <b>concrete</b> words words describe concepts that we can perceive more directly. </p>' +
        "<p>In this experiment, each screen will show a word in lower case, such as 'book'. </p>" +
        "Press <b>F</b> if the word is primarily abstract (for instance, 'attenuation')</p>" +
        "<p>or press <b>J</b> if the word is primarily concrete (for instance, 'table'). </p>" + 
        '<p>Please try to respond accurately and fast. The maximum response time is 3 seconds. </p>' + 
        "<p>Next, you can perform some practice trials. Correct responses will be indicated with <b><span style='color:green; background-color: #E1E1E1;'>&emsp; C &emsp;</span></b>; </p>" +
        "<p>incorrect responses with <b><span style='color:red; background-color: #E1E1E1;'>&emsp; X &emsp;</span></b>; and unanswered trials with <b><span style='color:red; background-color: #E1E1E1;'>&emsp; 0 &emsp;</span></b>. Press below to proceed.</p><br>"
      ],
      choices: ['Begin practice']
    }
    /* Add instructions to the timeline */
    timeline.push(instructions)


    /* Main procedure, administered after the initial practice trials */

    /* Minimum and maximum duration of semantic priming task set below.
    The minimum is administered to every participant. The maximum is 
    used to administer additional trials when a participant has not 
    responded to some of the minimum trials. */

    /* Set minimum and maximum number of trials per participant */
    var minimum_number_of_semanticpriming_trials = 15;
    var maximum_number_of_semanticpriming_trials =
      semanticpriming_stimuli_main_procedure.length;

    /* Set maximum duration of semantic priming task in milliseconds */
    var maximum_duration_of_semanticpriming_task = 100000;


    /* Next, create set of interstimulus intervals from a range between 60 and 
    1,200 ms. First, the range is split into as many integers as the minimum 
    number of trials, equally for all participants. Afterwards, all SOAs are 
    shuffled within participants. Finally, the random SOAs are repeated enough
    times to accommodate maximum_number_of_semanticpriming_trials. This process
    ensures that the range of SOAs administered to every participant includes
    both the minimum value (60 ms) and the maximum one (1,200 ms). */

    /* Enable function to create range of numbers */
    function makeArr(startValue, stopValue, cardinality) {
      var arr = [];
      var step = (stopValue - startValue) / (cardinality - 1);
      for (var i = 0; i < cardinality; i++) {
        arr.push(startValue + (step * i));
      }
      return arr;
    }

    /* Create range of SOAs */
    ordered_interstimulus_intervals =
      makeArr(60, 1200, minimum_number_of_semanticpriming_trials);

    /* Shuffle SOAs randomly (hence the .5 below) */
    interstimulus_interval =
      ordered_interstimulus_intervals.sort(function() {
        return 0.5 - Math.random()
      });

    /* Repeat the random sequence of SOAs as many times as the  
    maximum_number_of_semanticpriming_trials. This caters for 
    any extra trials administered after the minimum ones. */
    var interstimulus_interval =
      new Array(maximum_number_of_semanticpriming_trials).fill(interstimulus_interval).flat();


    /* Create trial information iteratively over trials using a for-of loop. 
    Three preparatory steps are performed before running the loop (Step 4). */

    /* 1. Enable function to create iterable range, 
    to be used in the for loop below */
    const Range = (start, end) => ({
      *[Symbol.iterator]() {
        while (start < end)
          yield start++;
      }
    })

    /* 2. Initialise stimuli array */
    stimuli = [];
    
    /* 3. Randomise trial order. First, the trial current order is stored. Second, the 
    `shuffle` function is created (https://stackoverflow.com/a/2450976/7050882). Last,
    the trial order is shuffled. */
    
    var trial_order = 
      Array.from({length: maximum_number_of_semanticpriming_trials}, (v, k) => k * 1);
      
    function shuffle(array) {
      let currentIndex = array.length,  randomIndex;
    
      // While there remain elements to shuffle.
      while (currentIndex != 0) {
    
        // Pick a remaining element.
        randomIndex = Math.floor(Math.random() * currentIndex);
        currentIndex--;
    
        // And swap it with the current element.
        [array[currentIndex], array[randomIndex]] = [
          array[randomIndex], array[currentIndex]];
      }
    
      return array;
    }

    var shuffled_trial_order = shuffle(trial_order);
    
    console.log(shuffled_trial_order);

    /* 4. Run loop */
    for (const i of shuffled_trial_order) {
      stimuli.push({
        trial: i + 1,  /* 1 is added because, otherwise, trials would start from 0, in the Javascript fashion. */
        prime_word: semanticpriming_stimuli_main_procedure[i].prime_word,
        target_word: semanticpriming_stimuli_main_procedure[i].target_word,
        interstimulus_interval: interstimulus_interval[i],
        correct_response: semanticpriming_stimuli_main_procedure[i].correct_response
      })
    }


    /* Every trial has six components: fixation, prime_word, interstimulus interval, 
    target_word, feedback, intertrial interval.
    
    NOTE on terminology. jsPsych provides a 'trial_index' value in the output of the 
    task. This index is assigned to all components of every trial. Thus, in the present 
    experiment, there are six trial_index values per trial. */

    /* Fixation cross */
    var fixation = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: '+',
      /* Choices set below to allow logging any premature response attempts. 
      No responses are expected in this part of the trial. */
      choices: ['f', 'j'],
      response_ends_trial: false,
      trial_duration: function() {
        /* Set fixations with a varying duration to boost participants' attention */
        return jsPsych.randomization.sampleWithoutReplacement([400, 450, 500, 550, 600], 1)[0];
      },
      post_trial_gap: 0,
      data: {
        trial: jsPsych.timelineVariable('trial')
      },
      css_classes: ['stimulus'],
      /* Computation run at the end of each trial */
      on_finish: function(data) {
        /* Log key presses, if any, by writing 1 into premature_response_attempts (else,
        write 0). At most, one premature response attempt is counted per trial. */
        if (data.response == null) {
          data.premature_response_attempts = premature_response_attempts = 0;
        } else {
          data.premature_response_attempts = 1;
        };
      }
    };

    var prime_word = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: jsPsych.timelineVariable('prime_word'),
      /* Choices set below to allow logging any premature response attempts. 
      No responses are expected in this part of the trial. */
      choices: ['f', 'j'],
      response_ends_trial: false,
      trial_duration: 150,
      post_trial_gap: 0,
      data: {
        trial: jsPsych.timelineVariable('trial')
      },
      css_classes: ['stimulus'],
      /* Computation run at the end of each trial */
      on_finish: function(data) {
        /* Log key presses, if any, by writing 1 into premature_response_attempts (else,
        write 0). At most, one premature response attempt is counted per trial. */
        if (data.response == null) {
          data.premature_response_attempts = premature_response_attempts = 0;
        } else {
          data.premature_response_attempts = 1;
        };
      }
    };

    var interstimulus_interval = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: ' ',
      /* Choices set below to allow logging any premature response attempts. 
      No responses are expected in this part of the trial. */
      choices: ['f', 'j'],
      response_ends_trial: false,
      trial_duration: jsPsych.timelineVariable('interstimulus_interval'),
      post_trial_gap: 0,
      data: {
        interstimulus_interval: jsPsych.timelineVariable('interstimulus_interval'),
        trial: jsPsych.timelineVariable('trial')
      },
      css_classes: ['stimulus'],
      /* Computation run at the end of each trial */
      on_finish: function(data) {
        /* Log key presses, if any, by writing 1 into premature_response_attempts (else,
        write 0). At most, one premature response attempt is counted per trial. */
        if (data.response == null) {
          data.premature_response_attempts = premature_response_attempts = 0;
        } else {
          data.premature_response_attempts = 1;
        };
      }
    };

    /* In the target word section of trials, all the key data are collected, 
    including information from previous sections of the same trial, such as 
    the prime word and the interstimulus interval. */
    var target_word = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: jsPsych.timelineVariable('target_word'),
      choices: ['f', 'j'],
      /* Set 3,000 ms as the maximum trial duration, the same as in the lexical decision 
      task of Hutchison et al. (2013; https://doi.org/10.3758/s13428-012-0304-z) and the 
      semantic decision task of Pexman et al. (2017; https://doi.org/10.3758/s13428-016-0720-6). */
      trial_duration: 3000,
      post_trial_gap: 0,
      css_classes: ['stimulus'],
      data: {
        trial: jsPsych.timelineVariable('trial'),
        prime_word: jsPsych.timelineVariable('prime_word'),
        target_word: jsPsych.timelineVariable('target_word'),
        interstimulus_interval: jsPsych.timelineVariable('interstimulus_interval'),
        correct_response: jsPsych.timelineVariable('correct_response')
      },
      
      /* Computation run at the end of each trial */
      on_finish: function(data) {
        
        if (data.response !== null) {
          /* Label correct responses */
          if ((data.correct_response == 'abstract' && data.response == 'f') ||
            (data.correct_response == 'concrete' && data.response == 'j')) {
            data.semanticpriming_accuracy = 'correct';
            /* Label incorrect responses */
          } else if ((data.correct_response == 'abstract' && data.response == 'j') ||
            (data.correct_response == 'concrete' && data.response == 'f')) {
            data.semanticpriming_accuracy = 'incorrect';
          }
          /* Label unanswered trials */
        } else {
          data.semanticpriming_accuracy = 'unanswered';
        };
        
        /* Total number of trials per participant up to this point */
        data.semanticpriming_total_trials_per_participant =
          jsPsych.data.get().last(2).values()[0].trial;

        /* General accuracy rate per participant up to this point */

        var semanticpriming_total_correct =
          jsPsych.data.get().filter({
            semanticpriming_accuracy: 'correct'
          }).count();
        var semanticpriming_total_incorrect =
          jsPsych.data.get().filter({
            semanticpriming_accuracy: 'incorrect'
          }).count();
        var semanticpriming_total_unanswered =
          jsPsych.data.get().filter({
            semanticpriming_accuracy: 'unanswered'
          }).count();

        data.semanticpriming_accuracy_rate_per_participant =
          Math.round(semanticpriming_total_correct /
            (semanticpriming_total_correct +
              semanticpriming_total_incorrect +
              semanticpriming_total_unanswered) *
            100);

        /* Total number of responses per participant up to this point */
        data.semanticpriming_total_responses_per_participant =
          semanticpriming_total_correct + semanticpriming_total_incorrect;

        /* Total premature response attempts per participant up to this point */
        data.semanticpriming_total_premature_response_attempts_per_participant =
          jsPsych.data.get().select('premature_response_attempts').sum();

        /* Average interstimulus interval per participant up to this point */
        data.semanticpriming_mean_interstimulus_interval_per_participant =
          jsPsych.data.get().select('interstimulus_interval').mean();

        /* End semantic priming task (i.e., its 'timeline') if the current number of 
        responses is equal to the minimum number of trials, of if the maximum number 
        of trials has been reached, or if the maximum duration of this task has been 
        exceeded. */
        if (data.semanticpriming_total_responses_per_participant == minimum_number_of_semanticpriming_trials ||
          /* Note that the trial number considered below is that of the previous trial */
          jsPsych.data.get().last(2).values()[0].trial > maximum_number_of_semanticpriming_trials ||
          jsPsych.data.getLastTrialData().values()[0].time_elapsed >= maximum_duration_of_semanticpriming_task) {
          jsPsych.endCurrentTimeline();
        };
      }
    };

    /* At the end of the feedback section in each trial, performance checks are performed, 
    which are used to assess whether the semantic priming task should stop. */
    feedback = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: function() {
        var last_trial_semanticpriming_accuracy =
          jsPsych.data.getLastTrialData().values()[0].semanticpriming_accuracy;
        if (last_trial_semanticpriming_accuracy == 'correct') {
          return '<p style="color:green; background-color: #E1E1E1;">&emsp; C &emsp;</p>';
        }
        else if (last_trial_semanticpriming_accuracy == 'incorrect') {
          return '<p style="color:red; background-color: #E1E1E1;">&emsp; X &emsp;</p>';
        } else if (last_trial_semanticpriming_accuracy == 'unanswered') {
          return '<p style="color:red; background-color: #E1E1E1;">&emsp; 0 &emsp;</p>'
        }
      },
      choices: 'NO_KEYS',
      trial_duration: 800
    };

    /* The intertrial interval is the last part of every trial */
    var intertrial_interval = {
      type: jsPsychHtmlKeyboardResponse,
      stimulus: ' ',
      trial_duration: function() {
        /* Set interval with a varying duration to boost participants' attention */
        return jsPsych.randomization.sampleWithoutReplacement([1400, 1450, 1500, 1550, 1600], 1)[0];
      },
      response_ends_trial: false,
      trial_duration: jsPsych.timelineVariable('interstimulus_interval'),
      post_trial_gap: 0,
      css_classes: ['stimulus']
    };


    var main_procedure = {
      timeline: [fixation, prime_word, interstimulus_interval,
        target_word, feedback, intertrial_interval
      ],
      timeline_variables: stimuli
    };
    /* Add main_procedure to the timeline */
    timeline.push(main_procedure);


    var debrief = {
      type: jsPsychHtmlKeyboardResponse,
      choices: ['c'],
      stimulus: function() {
        var semanticpriming_total_correct =
          jsPsych.data.get().filter({
            semanticpriming_accuracy: 'correct'
          }).count();
        var semanticpriming_total_incorrect =
          jsPsych.data.get().filter({
            semanticpriming_accuracy: 'incorrect'
          }).count();
        var semanticpriming_total_unanswered =
          jsPsych.data.get().filter({
            semanticpriming_accuracy: 'unanswered'
          }).count();
        var semanticpriming_accuracy_rate =
          Math.round(semanticpriming_total_correct /
            (semanticpriming_total_correct +
              semanticpriming_total_incorrect +
              semanticpriming_total_unanswered) * 100) + '%';
        var message = "<div style='font-size:20px;'><p>Finished! Thank you very much.</p><br>" +
          '<p>Your accuracy rate was ' + semanticpriming_accuracy_rate +
          ' (' + semanticpriming_total_correct + ' correct trials, ' +
          semanticpriming_total_incorrect + ' incorrect and ' +
          semanticpriming_total_unanswered + ' unanswered).</p>' +
          '<p>Press C to see the entire set of data generated by this experiment.</p></div>';
        return message;
      }
    }
    /* Add debrief to the timeline */
    timeline.push(debrief);
    
    
    /* Last but not least, run the experiment */
    jsPsych.run(timeline);

  </script>

</html>

